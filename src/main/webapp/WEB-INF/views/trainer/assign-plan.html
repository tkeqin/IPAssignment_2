<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Assign Fitness Plan - HealthHub@UTM</title>
    <div th:replace="trainer/header :: header-css"></div>
</head>
<body class="bg-light">
    <div th:replace="trainer/header :: header-nav"></div>

    <div class="container py-5">
        
        <!-- Unified Main Container -->
        <div class="card shadow border-0 rounded-4">
            <div class="card-body p-5">
                
                <!-- 1. Member Selection Section -->
                <div class="mb-4">
                    <h4 class="mb-3 fw-bold text-primary">Select Member</h4>
                    <form action="#" th:action="@{/trainer/plans/assign}" method="get">
                        <div class="row align-items-center">
                            <div class="col-md-8 col-lg-6">
                                <select class="form-select form-select-lg" name="selectedMemberId" onchange="this.form.submit()">
                                    <option value="" disabled th:selected="${selectedMemberId == null}">-- Choose a member --</option>
                                    <!-- ID removed from display text as requested -->
                                    <option th:each="m : ${members}" 
                                            th:value="${m.personId}" 
                                            th:text="${m.fullName}"
                                            th:selected="${selectedMemberId != null and selectedMemberId == m.personId}">
                                        Member Name
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <span class="text-muted small">Select to load details</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 2. Main Content Area (Only show if member is selected) -->
                <div th:if="${selectedMemberId != null}">
                    
                    <hr class="my-5 text-muted opacity-25">

                    <div class="row g-5">
                        <!-- LEFT COLUMN: Assignment Form -->
                        <div class="col-lg-5">
                            <h4 class="mb-4 fw-bold text-primary">Assign New Plan</h4>
                            
                            <form th:action="@{/trainer/plans/assign/save}" th:object="${assignment}" method="post">
                                <input type="hidden" name="memberId" th:value="${selectedMemberId}">
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Select Fitness Plan Template</label>
                                    <select name="planId" class="form-select" required>
                                        <option value="" disabled selected>-- Select Plan --</option>
                                        <option th:each="p : ${plans}" 
                                                th:value="${p.planId}" 
                                                th:text="${p.planName + ' (' + p.difficultyLevel + ')'}">
                                            Plan Name
                                        </option>
                                    </select>
                                    <div class="form-text mt-2">
                                        Choose a routine that fits the member's goals and enrolled program.
                                    </div>
                                </div>
                                
                                <div class="d-grid mt-5">
                                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                                        Confirm Assignment
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- RIGHT COLUMN: Member Stats & Enrollment Info -->
                        <!-- Added border-start-lg for visual separation on large screens -->
                        <div class="col-lg-7 border-start-lg ps-lg-5">
                            
                            <!-- Enrollment Info -->
                            <div class="mb-5">
                                <h5 class="mb-4 fw-bold text-secondary">Active Program Enrollments</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Program</th>
                                                <th>Duration</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${#lists.isEmpty(enrollments)}">
                                                <td colspan="4" class="text-center py-3 text-muted">
                                                    <em>Member is not enrolled in any programs yet.</em>
                                                </td>
                                            </tr>
                                            <tr th:each="enroll : ${enrollments}">
                                                <td class="fw-bold text-dark" th:text="${enroll.program.name}"></td>
                                                <td th:text="${enroll.program.durationWeeks + ' Weeks'}"></td>
                                                <td th:text="${enroll.enrollDate}"></td>
                                                <td>
                                                    <span class="badge rounded-pill" 
                                                          th:classappend="${enroll.status == 'ACTIVE' ? 'bg-success' : 'bg-secondary'}"
                                                          th:text="${enroll.status}">
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- BMI History -->
                            <div>
                                <h5 class="mb-4 fw-bold text-secondary">Recent BMI History</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Date</th>
                                                <th>Weight</th>
                                                <th>Height</th>
                                                <th>BMI</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:if="${#lists.isEmpty(bmiHistory)}">
                                                <td colspan="4" class="text-center py-3 text-muted">No BMI records found.</td>
                                            </tr>
                                            <tr th:each="record : ${bmiHistory}">
                                                <td th:text="${#temporals.format(record.recordDate, 'dd-MM-yyyy')}"></td>
                                                <td th:text="${record.weightKg + ' kg'}"></td>
                                                <td th:text="${record.heightCm + ' cm'}"></td>
                                                <td>
                                                    <span class="badge rounded-pill" 
                                                          th:classappend="${record.bmiValue < 18.5 ? 'bg-warning' : (record.bmiValue < 25 ? 'bg-success' : 'bg-danger')}"
                                                          th:text="${record.bmiValue}">
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</body>
</html>